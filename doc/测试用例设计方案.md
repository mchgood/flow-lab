# FlowLab 单元测试方案（按模块）

## 1. 目标与范围
覆盖 Mermaid 解析、流程引擎核心能力、服务层逻辑与事件机制。测试以**模块化单元测试**为主，辅以少量集成测试验证端到端流程。

## 2. 模块划分与测试类索引
| 模块 | 说明 | 主要测试类 |
|---|---|---|
| 解析器-词法 | Token 识别 | `MermaidLexerTest` |
| 解析器-语法/转换 | AST→FlowGraph 及解析入口 | `FlowParserServiceTest` |
| 引擎-模型 | 流程定义/实例/上下文 | `ExecutionContextTest`, `ProcessDefinitionTest`, `ProcessInstanceTest` |
| 引擎-表达式 | SpEL 计算与校验 | `SpELExpressionEngineTest` |
| 引擎-事件 | 事件对象与发布 | `ProcessEventTest`, `EventPublisherTest` |
| 引擎-执行器 | 节点执行器与注册表 | `StartNodeExecutorTest`, `TaskNodeExecutorTest`, `DecisionNodeExecutorTest`, `EndNodeExecutorTest`, `NodeExecutorRegistryTest` |
| 引擎-核心 | 流程执行与事件 | `ProcessEngineTest` |
| 引擎-服务层 | 定义/实例管理 | `ProcessDefinitionServiceTest`, `ProcessInstanceServiceTest` |
| 集成测试 | 端到端流程 | `ProcessEngineIntegrationTest` |
| 应用上下文 | Spring Boot 启动 | `FlowLabApplicationTests` |

## 3. 模块测试要点

### 3.1 解析器-词法（`MermaidLexerTest`）
- 关键字/方向解析：`flowchart/graph/subgraph/end`、`TD/TB/LR/RL/BT`
- 符号与箭头：`[]{}()`, `-->`, `|`
- 换行与标识符识别（含中文）

### 3.2 解析器-语法/转换（`FlowParserServiceTest`）
- 节点形状解析：矩形/菱形/圆形/圆角矩形
- 边与标签：`-->|标签|` 标签保留
- 方向与 JSON 输出（格式化/紧凑）
- 校验与错误输入（空字符串、非法语法）
- 子图测试（模块内覆盖）：
  - `testParseSimpleSubgraph`
  - `testParseSubgraphWithDifferentNodeShapes`
  - `testParseMultipleSubgraphs`
  - `testParseSubgraphWithComplexFlow`
  - `testParseSubgraphWithOnlyNodes`
  - `testParseSubgraphWithParallelBranches`
  - `testParseSubgraphWithRoundRectangleNodes`
  - `testParseEmptySubgraph`

### 3.3 引擎-模型
- `ExecutionContextTest`：变量增删查、默认值、拷贝
- `ProcessDefinitionTest`：状态枚举与字段赋值
- `ProcessInstanceTest`：实例状态与关联上下文

### 3.4 引擎-表达式（`SpELExpressionEngineTest`）
- 布尔表达式评估、数值计算、语法校验
- 异常与非法表达式处理

### 3.5 引擎-事件（`ProcessEventTest`, `EventPublisherTest`）
- 事件属性构造正确性
- 发布器对多监听器与异常隔离行为

### 3.6 引擎-执行器（各 NodeExecutor 测试）
- `getSupportedShape()`
- `execute()` 返回成功结果
- `validate()` 形状校验
- 任务节点执行后上下文变量写入

### 3.7 引擎-核心（`ProcessEngineTest`）
- 简单线性流程执行完成
- 条件分支流程可执行完成
- 事件发布（流程/节点事件）

### 3.8 引擎-服务层
- 流程定义创建/更新/部署/版本递增
- Mermaid 源码校验失败场景
- 流程实例创建/启动/暂停/恢复/终止

### 3.9 集成测试（`ProcessEngineIntegrationTest`）
- 订单审批流程（高/低金额分支）
- 事件监听器全流程
- 流程定义版本管理

## 4. 按模块运行测试
```bash
# 解析器
./mvnw test -Dtest=MermaidLexerTest
./mvnw test -Dtest=FlowParserServiceTest

# 引擎-模型
./mvnw test -Dtest=ExecutionContextTest,ProcessDefinitionTest,ProcessInstanceTest

# 引擎-表达式与事件
./mvnw test -Dtest=SpELExpressionEngineTest,ProcessEventTest,EventPublisherTest

# 引擎-执行器
./mvnw test -Dtest=StartNodeExecutorTest,TaskNodeExecutorTest,DecisionNodeExecutorTest,EndNodeExecutorTest,NodeExecutorRegistryTest

# 引擎-核心与服务
./mvnw test -Dtest=ProcessEngineTest,ProcessDefinitionServiceTest,ProcessInstanceServiceTest

# 集成测试
./mvnw test -Dtest=ProcessEngineIntegrationTest
```

## 5. 统一测试数据约定（示例）
- 线性流程：开始 → 任务 → 结束
- 条件分支：`#amount > 1000`、`#amount <= 1000`
- 子图：`subgraph ... end` 覆盖并行/循环/空子图场景
