# FlowLab 流程引擎设计文档

## 1. 目标与范围
在已解析的 Mermaid 流程图基础上，提供流程定义管理、流程实例执行、条件分支、事件发布与上下文变量管理能力。当前实现为**内存级、同步执行**，主要面向功能验证与扩展基线。

## 2. 模块划分（按代码结构）
```
com.gaibu.flowlab
├── engine
│   ├── model        # ProcessDefinition/Instance, ExecutionContext, NodeExecutionResult
│   ├── enums        # 状态枚举
│   ├── repository   # 内存仓库
│   ├── service      # 定义/实例服务
│   ├── core         # ProcessEngine 执行引擎
│   ├── executor     # Start/Task/Decision/End 执行器与注册表
│   ├── expression   # SpEL 表达式引擎
│   └── event        # 事件与发布器
├── service          # FlowParserService（解析服务）
└── transformer/parser  # Mermaid 解析与转换
```

## 3. 核心数据模型
- **ExecutionContext**：流程变量与上下文（Map 形式）。
- **ProcessDefinition**：流程定义（名称、版本、Mermaid 源码、JSON 结构等）。
- **ProcessInstance**：流程实例（状态、当前节点、上下文、起止时间）。
- **NodeExecutionResult**：节点执行结果（成功/失败、状态、输出）。

## 4. 关键流程
### 4.1 流程定义生命周期
1) `ProcessDefinitionService.create()` 验证 Mermaid 源码（调用 `FlowParserService.validate()`）
2) 解析并缓存 `flowGraphJson`
3) 按名称递增版本号（内存仓库）
4) `deploy()` 将状态置为 `ACTIVE`

### 4.2 流程实例执行流程
1) `ProcessInstanceService.createAndStart()` 创建实例并调用引擎执行
2) `ProcessEngine.execute()`：
   - 发布 `ProcessStartedEvent`
   - 解析 Mermaid 为 `FlowGraph`
   - 查找开始节点：**圆形节点且无入边**
   - 递归执行节点，直到无后继边
3) 执行结果：无后继边则 `COMPLETED`，执行异常则 `TERMINATED`

### 4.3 条件分支
- 若边有 `label`，则调用 `ExpressionEngine.evaluate(label)` 判定。
- 表达式语法：Spring SpEL，变量以 `#var` 引用。
- 表达式失败：记录错误输出，但不中断流程（该边不被选中）。

## 5. 执行器与事件机制
- 执行器：
  - `StartNodeExecutor` / `EndNodeExecutor`：支持 `circle`
  - `TaskNodeExecutor`：支持 `rectangle`，默认记录 `lastExecutedTask`
  - `DecisionNodeExecutor`：支持 `diamond`，路由由引擎完成
- 事件：
  - `ProcessStartedEvent`, `NodeStartedEvent`, `NodeCompletedEvent`, `ProcessCompletedEvent`
  - `EventPublisher` 逐个通知监听器，单个监听器异常不影响其他监听器

## 6. 设计约束与扩展方向
- 目前仓库与流程实例为内存实现（无持久化）。
- 执行过程为同步递归，不支持并行与异步节点。
- 没有任务处理器注册机制，仅提供基础任务执行示例。
- 可扩展方向：持久化、异步节点、任务插件、并发调度、审计日志。
