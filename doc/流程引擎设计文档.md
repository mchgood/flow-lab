# FlowLab 流程引擎设计文档

## 1. 目标与范围
在已解析的 Mermaid 流程图基础上，提供流程定义管理、流程实例执行、条件分支、事件发布与上下文变量管理能力。当前实现为**内存级、同步执行**，主要面向功能验证与扩展基线。

## 2. 模块划分（按代码结构）
```
com.gaibu.flowlab
├── engine
│   ├── model        # ProcessDefinition/Instance, ExecutionContext, NodeExecutionResult
│   ├── enums        # 状态枚举
│   ├── repository   # 内存仓库
│   ├── service      # 定义/实例服务
│   ├── core         # ProcessEngine 执行引擎
│   ├── executor     # Start/Task/Decision/End 执行器与注册表
│   ├── expression   # SpEL 表达式引擎
│   └── event        # 事件与发布器
├── service          # FlowParserService（解析服务）
└── transformer/parser  # Mermaid 解析与转换
```

## 3. 核心数据模型
- **ExecutionContext**：流程变量与上下文（Map 形式）。
- **ProcessDefinition**：流程定义（名称、版本、Mermaid 源码、JSON 结构等）。
- **ProcessInstance**：流程实例（状态、当前节点、上下文、起止时间）。
- **NodeExecutionResult**：节点执行结果（成功/失败、状态、输出）。

## 4. 关键流程
### 4.1 流程定义生命周期
1) `ProcessDefinitionService.create()` 验证 Mermaid 源码（调用 `FlowParserService.validate()`）
2) 解析并缓存 `flowGraphJson`
3) 按名称递增版本号（内存仓库）
4) `deploy()` 将状态置为 `ACTIVE`

### 4.2 流程实例执行流程（拟改造）
1) `ProcessInstanceService.createAndStart()` 创建实例并调用引擎执行  
2) `ProcessEngine.execute()`：
   - 发布 `ProcessStartedEvent`
   - 解析 Mermaid 为 `FlowGraph`
   - 查找开始节点：**显式 start 形状或标记，避免与结束节点同形状冲突**
   - 以**迭代/队列调度**替代递归执行，加入**已访问节点集合 + 最大跳转阈值**做循环检测
3) 执行结果：无后继边则 `COMPLETED`，执行异常则 `TERMINATED`

### 4.3 条件分支
- **展示标签与条件表达式分离**：边模型区分 `label`（展示）与 `condition`（可选 SpEL）。解析阶段识别特定前缀/语法填充 `condition`，普通文字标签不再被当作表达式。
- 表达式语法：Spring SpEL，变量以 `#var` 引用。
- 表达式失败：记录错误输出，但不中断流程（该边不被选中）。

## 5. 执行器与事件机制
- 执行器注册：
  - 计划为**开始/结束节点使用不同形状或显式类型键**，避免当前 `circle` 形状被多个执行器互相覆盖。
  - 注册表可支持同形状多执行器或类型优先匹配。
  - `TaskNodeExecutor`：支持 `rectangle`，默认记录 `lastExecutedTask`
  - `DecisionNodeExecutor`：支持 `diamond`，路由由引擎完成
- 事件：
  - `ProcessStartedEvent`, `NodeStartedEvent`, `NodeCompletedEvent`, `ProcessCompletedEvent`
  - `EventPublisher` 逐个通知监听器，单个监听器异常不影响其他监听器；预留异步/批量发布扩展点。

## 6. 设计约束、已知风险与演进计划
- **解析/转换职责重叠**：`FlowParserService` 同时构建 nodeMap 且 transformer 再次收集，易遗漏隐式节点；计划由 transformer 统一收集，服务层不再双写。
- **形状支持不一致**：`NodeShape` 列出 hexagon/parallelogram/trapezoid，但 lexer/parser 未识别；需统一语法或移除未实现形状。
- **起止节点冲突**：开始/结束同为 `circle`，导致执行器覆盖、起点识别混淆；拟引入独立“start”形状或 start/end 标记。
- **循环与重入控制缺失**：递归执行缺乏环路检测；将增加访问记录、最大深度阈值并改为迭代调度。
- **条件标签歧义**：普通文字标签被当作 SpEL 解析；通过 `label`/`condition` 分离并限定条件语法解决。
- **基础设施抽象不足**：仓库与事件发布为内存同步实现；后续提供接口层，内存版作为默认实现，便于接入持久化与异步通道。
